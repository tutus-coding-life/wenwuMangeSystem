{% extends "base.html" %}

{% block title %}展览{% endblock %}

{% block content %}
{# 如果传入的是展览列表 (exhibitions)，则展示列表视图 #}
{% if exhibitions is defined and exhibitions %}
<div class="container mt-4">
  <h1>展览</h1>
  {% for item in exhibitions %}
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">{{ item.exhibition.name }}</h5>
      <p class="card-text">{{ item.exhibition.description }}</p>
      <p class="card-text"><small class="text-muted">开始日期: {{ item.exhibition.start_date or '—' }} | 结束日期: {{ item.exhibition.end_date or '—' }}</small></p>
      {% if item.artifacts %}
      <h6>文物:</h6>
      <ul>
        {% for artifact in item.artifacts %}
        <li>{{ artifact.name }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="text-muted">暂无展出文物</div>
      {% endif %}
    </div>
  </div>
  {% endfor %}

  {% if pagination and pagination.pages > 1 %}
  <nav aria-label="Page navigation">
    <ul class="pagination">
      {% if pagination.has_prev %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.prev_num }}">上一页</a></li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">上一页</span></li>
      {% endif %}

      {% for page in pagination.iter_pages() %}
        {% if page %}
          {% if page == pagination.page %}
            <li class="page-item active"><span class="page-link">{{ page }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ page }}">{{ page }}</a></li>
          {% endif %}
        {% else %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.next_num }}">下一页</a></li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">下一页</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

{# 单个展览视图：如果路由传入 `exhibition`（和相关上下文），则显示详情和筛选 #}
{% elif exhibition is defined %}
<h2>{{ exhibition.name }}</h2>
<p class="text-muted">{{ exhibition.start_date or '—' }} 至 {{ exhibition.end_date or '—' }}</p>
{% if exhibition.description %}
<div class="mb-3">{{ exhibition.description }}</div>
{% endif %}

<!-- 筛选表单（只有在提供相关上下文时显示） -->
{% if categories is defined or dynasties is defined or object_types is defined %}
<form method="get" class="mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label small">名称包含</label>
      <input type="text" name="q" value="{{ q or '' }}" class="form-control form-control-sm" placeholder="名称关键词">
    </div>
    <div class="col-md-2">
      <label class="form-label small">类别</label>
      <select name="category" class="form-select form-select-sm">
        <option value="">全部</option>
        {% for c in categories %}
        <option value="{{ c.id }}" {% if selected_category==c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small">朝代</label>
      <select name="dynasty" class="form-select form-select-sm">
        <option value="">全部</option>
        {% for d in dynasties %}
        <option value="{{ d.id }}" {% if selected_dynasty==d.id %}selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small">对象类型</label>
      <select name="object_type" class="form-select form-select-sm">
        <option value="">全部</option>
        {% for o in object_types %}
        <option value="{{ o.id }}" {% if selected_object_type==o.id %}selected{% endif %}>{{ o.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-1">
      <button class="btn btn-primary btn-sm">筛选</button>
    </div>
  </div>
</form>
{% endif %}

{% if artifacts %}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  {% for artifact in artifacts %}
  <div class="col">
    <div class="card h-100 shadow-sm border-0">
      <div style="height:200px;">
        {% if artifact.image %}
        <img src="{{ artifact.image.url }}" class="card-img-top h-100 w-100 object-fit-cover" alt="{{ artifact.name }}">
        {% else %}
        <div class="bg-light d-flex align-items-center justify-content-center h-100">无图片</div>
        {% endif %}
      </div>
      <div class="card-body d-flex flex-column">
        <h5 class="card-title">{{ artifact.name }}</h5>
        <div class="text-muted small flex-grow-1">
          <div>类别：{{ artifact.category.name if artifact.category else '—' }}</div>
          <div>朝代：{{ artifact.dynasty.name if artifact.dynasty else '—' }}</div>
        </div>
        <div class="mt-3">
            {% if current_user.role == 'admin' and (link_map is defined and link_map.get(artifact.id)) %}
            <form action="{{ url_for('remove_artifact_from_exhibition', exhibition_id=exhibition.id, link_id=link_map.get(artifact.id)) }}" method="post" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定移除该文物吗？')">移除</button>
            </form>
            {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="text-center py-5">暂无展出文物</div>
{% endif %}

{% if pagination is defined and pagination.pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% if pagination.has_prev %}
    <li class="page-item"><a class="page-link" href="?page={{ pagination.prev_num }}">上一页</a></li>
    {% endif %}
    {% for p in pagination.iter_pages() %}
      {% if p %}
        {% if p != pagination.page %}
        <li class="page-item"><a class="page-link" href="?page={{ p }}">{{ p }}</a></li>
        {% else %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
    {% endfor %}
    {% if pagination.has_next %}
    <li class="page-item"><a class="page-link" href="?page={{ pagination.next_num }}">下一页</a></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% else %}
<p class="text-center py-4">暂无展览</p>
{% endif %}

{% endblock %}
